<html>
<head>
<!--       <script src="https://fb.me/react-15.1.0.js"></script>
    <script src="https://fb.me/react-dom-15.1.0.js"></script>
 -->
   
    <script src="https://unpkg.com/react@16/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@16/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/babel-standalone@6.15.0/babel.min.js"></script>
 </head>
<body>

<div id="client1">
  <ul>
  </ul>
  <div id="state"></div>
</div>
<hr />
<div id="client2">
  <ul>
  </ul>
  <div id="state"></div>
</div>
<hr />
<div id="client3">
  <ul>
  </ul>
  <div id="state"></div>
</div>
<hr />
<div id="client4">
  <ul>
  </ul>
  <div id="state"></div>
</div>

    <script>
      class Client {

        constructor(ui){
          this.ui = ui;
          this.connectToAnyServer = this.connectToAnyServer.bind(this)
        }

        updateState(state){
          this.ui.querySelector('#state').innerHTML = state;
        }
        
        connectToServer(serverUrl){
            let self = this;
            this.updateState('CONNECTING: ' + serverUrl)

            this.serverUrl = serverUrl;
            console.log("connecting to -> ", serverUrl)

            let ws = new WebSocket(serverUrl);

            ws.onopen = function(evt) {
              // ws.send(msg);
              self.updateState('CONNECTED: ' + serverUrl)
            }

            ws.onmessage = function(evt) {
              // handle this message
              console.log(evt.data);
            }

            ws.onclose = function(evt) {
              self.updateState('DISCONNECTED: ' + serverUrl)
              // console.log("onclose", evt)
              // console.log("retrying connect")
              // setTimeout(()=>{
              //   self.connectToAnyServer()
              // }, 3500)
            }

            ws.onerror = function(evt) {
                console.log("onerror", evt)
            }

        }


        connectToAnyServer(){
            let self = this;
            fetch('http://localhost:9081/servers/')
            .then(function(response) {
                return response.json();
            })
            .then(function(servers) {
              let server = null;
              for (let k in servers){
                if (k.indexOf(':9081')===-1){
                  console.log("-> server ->", k)
                  server = k;
                }
              }
              self.connectToServer(server)
            });
        }

      }

      let client1 = new Client(document.getElementById('client1'))
      let client2 = new Client(document.getElementById('client2'))
      let client3 = new Client(document.getElementById('client3'))
      let client4 = new Client(document.getElementById('client4'))
      //
      // client1.connectToServer('ws://localhost:9081/events/')
      // client2.connectToServer('ws://localhost:9082/events/')
      // client3.connectToServer('ws://localhost:9083/events/')
      // client4.connectToAnyServer()

    </script>

<!--     <div id="root"></div>
    <script type="text/babel">

      class Player 

      let Clients = (props)=>{
        <div>
          {props.clients.forEach(()=><Player />)}
        </div>
      }

      ReactDOM.render(
        Clients,
        document.getElementById('root')
      );

    </script> -->

</body>
</html>